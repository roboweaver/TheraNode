/*!
 * jQuery QueryBuilder 1.4.1
 * Copyright 2014-2015 Damien "Mistic" Sorel (http://www.strangeplanet.fr)
 * Licensed under MIT (http://opensource.org/licenses/MIT)
 */
function iterateOptions(a,b){a&&($.isArray(a)?$.each(a,function(a,c){$.isPlainObject(c)?$.each(c,function(a,c){return b(a,c),!1}):b(a,c)}):$.each(a,function(a,c){b(a,c)}))}function fmt(a,b){return b=Array.prototype.slice.call(arguments),a.replace(/{([0-9]+)}/g,function(a,c){return b[parseInt(c)+1]})}function changeType(a,b,c){switch(b){case"integer":return parseInt(a);case"double":return parseFloat(a);case"boolean":var d="true"===a.trim().toLowerCase()||"1"===a.trim()||1===a;if("sql"===c)return d?1:0;if("mongo"===c)return d;break;default:return a}}function escapeRegExp(a){return a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}function moveSortableToTarget(a,b){var c;return c=b.closest(".rule-container"),c.length?void a.detach().insertAfter(c):(c=b.closest(".rules-group-header"),c.length?(c=b.closest(".rules-group-container"),void a.detach().prependTo(c.find(".rules-list").eq(0))):(c=b.closest(".rules-group-container"),c.length?void a.detach().appendTo(c.find(".rules-list").eq(0)):void 0))}function changeType(a,b,c){switch(b){case"integer":return parseInt(a);case"double":return parseFloat(a);case"boolean":var d="true"===a.trim().toLowerCase()||"1"===a.trim()||1===a;if("sql"===c)return d?1:0;if("mongo"===c)return d;break;default:return a}}function escapeString(a){return"string"!=typeof a?a:a.replace(/[\0\n\r\b\\\'\"]/g,function(a){switch(a){case"\x00":return"\\0";case"\n":return"\\n";case"\r":return"\\r";case"\b":return"\\b";default:return"\\"+a}}).replace(/\t/g,"\\t").replace(/\x1a/g,"\\Z")}!function(a,b){"function"==typeof define&&define.amd?define(["jquery","microevent","jQuery.extendext"],b):b(a.jQuery,a.MicroEvent)}(this,function(){"use strict";"@@js\r\n"});var types=["string","integer","double","date","time","datetime","boolean"],internalTypes=["string","number","datetime","boolean"],inputs=["text","textarea","radio","checkbox","select"],QueryBuilder=function(a,b){this.$el=a,this.init(b)};MicroEvent.mixin(QueryBuilder),QueryBuilder.DEFAULTS={filters:[],plugins:null,onValidationError:null,onAfterAddGroup:null,onAfterAddRule:null,display_errors:!0,allow_groups:-1,allow_empty:!1,conditions:["AND","OR"],default_condition:"AND",default_rule_flags:{filter_readonly:!1,operator_readonly:!1,value_readonly:!1,no_delete:!1},template:{group:null,rule:null},lang:{add_rule:"Add rule",add_group:"Add group",delete_rule:"Delete",delete_group:"Delete",condition_and:"AND",condition_or:"OR",filter_select_placeholder:"------",operators:{equal:"equal",not_equal:"not equal","in":"in",not_in:"not in",less:"less",less_or_equal:"less or equal",greater:"greater",greater_or_equal:"greater or equal",between:"between",begins_with:"begins with",not_begins_with:"doesn't begin with",contains:"contains",not_contains:"doesn't contain",ends_with:"ends with",not_ends_with:"doesn't end with",is_empty:"is empty",is_not_empty:"is not empty",is_null:"is null",is_not_null:"is not null"},errors:{no_filter:"No filter selected",empty_group:"The group is empty",radio_empty:"No value selected",checkbox_empty:"No value selected",select_empty:"No value selected",string_empty:"Empty value",string_exceed_min_length:"Must contain at least {0} characters",string_exceed_max_length:"Must not contain more than {0} characters",string_invalid_format:"Invalid format ({0})",number_nan:"Not a number",number_not_integer:"Not an integer",number_not_double:"Not a real number",number_exceed_min:"Must be greater than {0}",number_exceed_max:"Must be lower than {0}",number_wrong_step:"Must be a multiple of {0}",datetime_invalid:"Invalid date format ({0})",datetime_exceed_min:"Must be after {0}",datetime_exceed_max:"Must be before {0}",boolean_not_valid:"Not a boolean"}},operators:[{type:"equal",accept_values:1,apply_to:["string","number","datetime","boolean"]},{type:"not_equal",accept_values:1,apply_to:["string","number","datetime","boolean"]},{type:"in",accept_values:1,apply_to:["string","number","datetime"]},{type:"not_in",accept_values:1,apply_to:["string","number","datetime"]},{type:"less",accept_values:1,apply_to:["number","datetime"]},{type:"less_or_equal",accept_values:1,apply_to:["number","datetime"]},{type:"greater",accept_values:1,apply_to:["number","datetime"]},{type:"greater_or_equal",accept_values:1,apply_to:["number","datetime"]},{type:"between",accept_values:2,apply_to:["number","datetime"]},{type:"begins_with",accept_values:1,apply_to:["string"]},{type:"not_begins_with",accept_values:1,apply_to:["string"]},{type:"contains",accept_values:1,apply_to:["string"]},{type:"not_contains",accept_values:1,apply_to:["string"]},{type:"ends_with",accept_values:1,apply_to:["string"]},{type:"not_ends_with",accept_values:1,apply_to:["string"]},{type:"is_empty",accept_values:0,apply_to:["string"]},{type:"is_not_empty",accept_values:0,apply_to:["string"]},{type:"is_null",accept_values:0,apply_to:["string","number","datetime","boolean"]},{type:"is_not_null",accept_values:0,apply_to:["string","number","datetime","boolean"]}],icons:{add_group:"glyphicon glyphicon-plus-sign",add_rule:"glyphicon glyphicon-plus",remove_group:"glyphicon glyphicon-remove",remove_rule:"glyphicon glyphicon-remove",error:"glyphicon glyphicon-warning-sign"}},QueryBuilder.plugins={},QueryBuilder.define=function(a,b){QueryBuilder.plugins[a]=b},QueryBuilder.extend=function(a){$.extend(QueryBuilder.prototype,a)},QueryBuilder.prototype.initPlugins=function(){if(this.settings.plugins){var a=this,b={};$.isArray(this.settings.plugins)?$.each(this.settings.plugins,function(a,c){b[c]={}}):$.each(this.settings.plugins,function(a,c){b[a]=c}),$.each(b,function(b,c){b in QueryBuilder.plugins?QueryBuilder.plugins[b].call(a,c):$.error('Unable to find plugin "'+b+'"')})}},QueryBuilder.prototype.init=function(a){this.settings=$.extendext(!0,"replace",{},QueryBuilder.DEFAULTS,a),this.status={group_id:0,rule_id:0,generatedId:!1,has_optgroup:!1},this.settings.allow_groups===!1?this.settings.allow_groups=0:this.settings.allow_groups===!0&&(this.settings.allow_groups=-1),this.filters=this.settings.filters,this.lang=this.settings.lang,this.icons=this.settings.icons,this.operators=this.settings.operators,this.template=this.settings.template,null===this.template.group&&(this.template.group=this.getGroupTemplate),null===this.template.rule&&(this.template.rule=this.getRuleTemplate),(!this.filters||this.filters.length<1)&&$.error("Missing filters list"),this.checkFilters(),this.$el.attr("id")||(this.$el.attr("id","qb_"+Math.floor(99999*Math.random())),this.status.generatedId=!0),this.$el_id=this.$el.attr("id"),this.$el.addClass("query-builder"),this.bindEvents(),this.initPlugins(),this.trigger("afterInit"),a.rules?this.setRules(a.rules):this.addGroup(this.$el)},QueryBuilder.prototype.destroy=function(){this.trigger("beforeDestroy"),this.status.generatedId&&this.$el.removeAttr("id"),this.$el.empty().off("click.queryBuilder change.queryBuilder").removeClass("query-builder").removeData("queryBuilder")},QueryBuilder.prototype.reset=function(){this.status.group_id=1,this.status.rule_id=0,this.$el.find(">.rules-group-container>.rules-group-body>.rules-list").empty(),this.addRule(this.$el.find(">.rules-group-container")),this.trigger("afterReset")},QueryBuilder.prototype.clear=function(){this.status.group_id=0,this.status.rule_id=0,this.$el.empty(),this.trigger("afterClear")},QueryBuilder.prototype.getRules=function(){this.clearErrors();var a=this.$el.find(">.rules-group-container"),b=this,c=function d(a){var c={},e=a.find(">.rules-group-body>.rules-list>*");c.condition=b.getGroupCondition(a),c.rules=[];for(var f=0,g=e.length;g>f;f++){var h,i=e.eq(f);if(i.hasClass("rule-container")){var j=b.getRuleFilter(i);if("-1"==j)return b.triggerValidationError(["no_filter"],i,null,null,null),{};var k=b.getFilterById(j),l=b.getOperatorByType(b.getRuleOperator(i)),m=null;if(0!==l.accept_values){m=b.getRuleValue(i,k,l);var n=b.validateValue(i,m,k,l);if(n!==!0)return b.triggerValidationError(n,i,m,k,l),{}}h={id:k.id,field:k.field,type:k.type,input:k.input,operator:l.type,value:m},c.rules.push(h)}else{if(h=d(i),$.isEmptyObject(h))return{};c.rules.push(h)}}return 0===c.rules.length&&(!b.settings.allow_empty||a.data("queryBuilder").level>1)?(b.triggerValidationError(["empty_group"],a,null,null,null),{}):c}(a);return this.change("getRules",c)},QueryBuilder.prototype.setRules=function(a){this.clear(),a&&a.rules&&(0!==a.rules.length||this.settings.allow_empty)||$.error("Incorrect data object passed"),a=this.change("setRules",a);var b=this.$el,c=this;!function d(a,b){var e=c.addGroup(b,!1);if(null!==e){var f=e.find(">.rules-group-header [name$=_cond]");void 0===a.condition&&(a.condition=c.settings.default_condition);for(var g=0,h=c.settings.conditions.length;h>g;g++){var i=c.settings.conditions[g];f.filter("[value="+i+"]").prop("checked",a.condition.toUpperCase()==i.toUpperCase())}f.trigger("change"),$.each(a.rules,function(a,b){if(b.rules&&b.rules.length>0)-1!==c.settings.allow_groups&&c.settings.allow_groups<e.data("queryBuilder").level?(c.reset(),$.error(fmt("No more than {0} groups are allowed",c.settings.allow_groups))):d(b,e);else{void 0===b.id&&$.error("Missing rule field id"),void 0===b.value&&(b.value=""),void 0===b.operator&&(b.operator="equal");var f=c.addRule(e);if(null===f)return;var g=c.getFilterById(b.id),h=c.getOperatorByType(b.operator);f.find(".rule-filter-container [name$=_filter]").val(b.id).trigger("change"),f.find(".rule-operator-container [name$=_operator]").val(b.operator).trigger("change"),0!==h.accept_values&&c.setRuleValue(f,b.value,g,h),c.applyRuleFlags(f,b)}})}}(a,b)},QueryBuilder.prototype.checkFilters=function(){var a=[],b=this;if($.each(this.filters,function(c,d){switch(d.id||$.error("Missing filter id: "+c),-1!=a.indexOf(d.id)&&$.error("Filter already defined: "+d.id),a.push(d.id),d.type||$.error("Missing filter type: "+d.id),-1==types.indexOf(d.type)&&$.error("Invalid type: "+d.type),d.input?"function"!=typeof d.input&&-1==inputs.indexOf(d.input)&&$.error("Invalid input: "+d.input):d.input="text",d.field||(d.field=d.id),d.label||(d.label=d.field),b.status.has_optgroup|=!!d.optgroup,d.optgroup||(d.optgroup=null),d.type){case"string":d.internalType="string";break;case"integer":case"double":d.internalType="number";break;case"date":case"time":case"datetime":d.internalType="datetime";break;case"boolean":d.internalType="boolean"}switch(d.input){case"radio":case"checkbox":(!d.values||d.values.length<1)&&$.error("Missing values for filter: "+d.id)}}),this.status.has_optgroup){var c=[],d=[];$.each(this.filters,function(a,b){var e;b.optgroup?(e=c.lastIndexOf(b.optgroup),-1==e&&(e=c.length)):e=c.length,c.splice(e,0,b.optgroup),d.splice(e,0,b)}),this.filters=d}this.trigger("afterCheckFilters")},QueryBuilder.prototype.bindEvents=function(){var a=this;this.$el.on("change.queryBuilder",".rules-group-header [name$=_cond]",function(){var a=$(this);a.is(":checked")&&a.parent().addClass("active").siblings().removeClass("active")}),this.$el.on("change.queryBuilder",".rule-filter-container [name$=_filter]",function(){var b=$(this),c=b.closest(".rule-container");a.updateRuleFilter(c,b.val())}),this.$el.on("change.queryBuilder",".rule-operator-container [name$=_operator]",function(){var b=$(this),c=b.closest(".rule-container");a.updateRuleOperator(c,b.val())}),this.$el.on("click.queryBuilder","[data-add=rule]",function(){var b=$(this),c=b.closest(".rules-group-container");a.addRule(c)}),this.$el.on("click.queryBuilder","[data-delete=rule]",function(){var b=$(this),c=b.closest(".rule-container");a.deleteRule(c)}),0!==this.settings.allow_groups&&(this.$el.on("click.queryBuilder","[data-add=group]",function(){var b=$(this),c=b.closest(".rules-group-container");a.addGroup(c)}),this.$el.on("click.queryBuilder","[data-delete=group]",function(){var b=$(this),c=b.closest(".rules-group-container");a.deleteGroup(c)}))},QueryBuilder.prototype.addGroup=function(a,b){var c=this.nextGroupId(),d=((a.data("queryBuilder")||{}).level||0)+1,e=1===d?a:a.find(">.rules-group-body>.rules-list"),f=$(this.template.group.call(this,c,d));f.data("queryBuilder",{level:d});var g=$.Event("addGroup.queryBuilder",{group_id:c,level:d,addRule:b,group:f,parent:a,builder:this});return this.$el.trigger(g),g.isDefaultPrevented()?null:(e.append(f),this.settings.onAfterAddGroup&&this.settings.onAfterAddGroup.call(this,f),this.trigger("afterAddGroup",f),(void 0===b||b===!0)&&this.addRule(f),f)},QueryBuilder.prototype.deleteGroup=function(a){if(a[0].id!=this.$el_id+"_group_0"){var b=$.Event("deleteGroup.queryBuilder",{group_id:a[0].id,group:a,builder:this});if(this.$el.trigger(b),b.isDefaultPrevented())return!1;this.trigger("beforeDeleteGroup",a);var c=this,d=!1;return a.find(">.rules-group-body>.rules-list>*").each(function(){var a=$(this);a.hasClass("rule-container")?a.data("queryBuilder").flags.no_delete?d=!0:a.remove():d|=!c.deleteGroup(a)}),d||a.remove(),!d}},QueryBuilder.prototype.addRule=function(a){var b=this.nextRuleId(),c=a.find(">.rules-group-body>.rules-list"),d=$(this.template.rule.call(this,b)),e=$(this.getRuleFilterSelect(b));d.data("queryBuilder",{flags:{}});var f=$.Event("addRule.queryBuilder",{rule_id:b,rule:d,parent:a,builder:this});return this.$el.trigger(f),f.isDefaultPrevented()?null:(c.append(d),d.find(".rule-filter-container").append(e),this.settings.onAfterAddRule&&this.settings.onAfterAddRule.call(this,d),this.trigger("afterAddRule",d),d)},QueryBuilder.prototype.deleteRule=function(a){var b=$.Event("deleteRule.queryBuilder",{rule_id:a[0].id,rule:a,builder:this});return this.$el.trigger(b),b.isDefaultPrevented()?!1:(this.trigger("beforeDeleteRule",a),a.remove(),!0)},QueryBuilder.prototype.createRuleOperators=function(a,b){var c=a.find(".rule-operator-container").empty();if(null!==b){var d=this.getOperators(b),e=$(this.getRuleOperatorSelect(a.attr("id"),d));c.html(e),a.data("queryBuilder").operator=d[0],this.trigger("afterCreateRuleOperators",a,b,d)}},QueryBuilder.prototype.createRuleInput=function(a,b){var c=a.find(".rule-value-container").empty();if(null!==b){var d=this.getOperatorByType(this.getRuleOperator(a));if(0!==d.accept_values){for(var e=$(),f=0;f<d.accept_values;f++){var g=$(this.getRuleInput(a,b,f));f>0&&c.append(" , "),c.append(g),e=e.add(g)}c.show(),b.onAfterCreateRuleInput&&b.onAfterCreateRuleInput.call(this,a,b),b.plugin&&e[b.plugin](b.plugin_config||{}),void 0!==b.default_value&&this.setRuleValue(a,b.default_value,b,d),this.trigger("afterCreateRuleInput",a,b,d)}}},QueryBuilder.prototype.updateRuleFilter=function(a,b){var c="-1"!=b?this.getFilterById(b):null;this.createRuleOperators(a,c),this.createRuleInput(a,c),a.data("queryBuilder").filter=c,this.trigger("afterUpdateRuleFilter",a,c)},QueryBuilder.prototype.updateRuleOperator=function(a,b){var c=a.find(".rule-value-container"),d=this.getFilterById(this.getRuleFilter(a)),e=this.getOperatorByType(b);if(0===e.accept_values)c.hide();else{c.show();var f=a.data("queryBuilder").operator;(c.is(":empty")||e.accept_values!=f.accept_values)&&this.createRuleInput(a,d)}a.data("queryBuilder").operator=e,d.onAfterChangeOperator&&d.onAfterChangeOperator.call(this,a,d,e),this.trigger("afterChangeOperator",a,d,e)},QueryBuilder.prototype.validateValue=function(a,b,c,d){var e=c.validation||{},f=!0;if(b=1==d.accept_values?[b]:b,e.callback)return f=e.callback.call(this,b,c,d,a),this.change("validateValue",f,a,b,c,d);for(var g=0;g<d.accept_values;g++){switch(c.input){case"radio":if(void 0===b[g]){f=["radio_empty"];break}break;case"checkbox":if(0===b[g].length){f=["checkbox_empty"];break}break;case"select":if(c.multiple){if(0===b[g].length){f=["select_empty"];break}}else if(void 0===b[g]){f=["select_empty"];break}break;default:switch(c.internalType){case"string":if(void 0!==e.min){if(b[g].length<e.min){f=["string_exceed_min_length",e.min];break}}else if(0===b[g].length){f=["string_empty"];break}if(void 0!==e.max&&b[g].length>e.max){f=["string_exceed_max_length",e.max];break}if(e.format&&!e.format.test(b[g])){f=["string_invalid_format",e.format];break}break;case"number":if(isNaN(b[g])){f=["number_nan"];break}if("integer"==c.type){if(parseInt(b[g])!=b[g]){f=["number_not_integer"];break}}else if(parseFloat(b[g])!=b[g]){f=["number_not_double"];break}if(void 0!==e.min&&b[g]<e.min){f=["number_exceed_min",e.min];break}if(void 0!==e.max&&b[g]>e.max){f=["number_exceed_max",e.max];break}if(void 0!==e.step){var h=b[g]/e.step;if(parseInt(h)!=h){f=["number_wrong_step",e.step];break}}break;case"datetime":if(window.moment&&e.format){var i=moment(b[g],e.format);if(!i.isValid()){f=["datetime_invalid"];break}if(e.min&&i<moment(e.min,e.format)){f=["datetime_exceed_min",e.min];break}if(e.max&&i>moment(e.max,e.format)){f=["datetime_exceed_max",e.max];break}}break;case"boolean":if("true"!==b[g].trim().toLowerCase()&&"false"!==b[g].trim().toLowerCase()&&"1"!==b[g].trim()&&"0"!==b[g].trim()&&1!==b[g]&&0!==b[g]){f=["boolean_not_valid"];break}}}if(f!==!0)break}return this.change("validateValue",f,a,b,c,d)},QueryBuilder.prototype.clearErrors=function(){this.$el.find(".has-error").removeClass("has-error")},QueryBuilder.prototype.triggerValidationError=function(a,b,c,d,e){$.isArray(a)||(a=[a]),d&&d.onValidationError&&d.onValidationError.call(this,b,a,c,d,e),this.settings.onValidationError&&this.settings.onValidationError.call(this,b,a,c,d,e);var f=$.Event("validationError.queryBuilder",{error:a,filter:d,operator:e,value:c,targetRule:b[0],builder:this});if(this.$el.trigger(f),this.settings.display_errors&&!f.isDefaultPrevented()){var g=$.extend([],a,[this.lang.errors[a[0]]||a[0]]);b.addClass("has-error");var h=b.find(".error-container").eq(0);h.attr("title",fmt.apply(null,g))}this.trigger("validationError",b,a)},QueryBuilder.prototype.nextGroupId=function(){return this.$el_id+"_group_"+this.status.group_id++},QueryBuilder.prototype.nextRuleId=function(){return this.$el_id+"_rule_"+this.status.rule_id++},QueryBuilder.prototype.getOperators=function(a){"string"==typeof a&&(a=this.getFilterById(a));for(var b=[],c=0,d=this.operators.length;d>c;c++){if(a.operators){if(-1==a.operators.indexOf(this.operators[c].type))continue}else if(-1==this.operators[c].apply_to.indexOf(a.internalType))continue;b.push(this.operators[c])}return a.operators&&b.sort(function(b,c){return a.operators.indexOf(b.type)-a.operators.indexOf(c.type)}),this.change("getOperators",b,a)},QueryBuilder.prototype.getFilterById=function(a){for(var b=0,c=this.filters.length;c>b;b++)if(this.filters[b].id==a)return this.filters[b];$.error("Undefined filter: "+a)},QueryBuilder.prototype.getOperatorByType=function(a){for(var b=0,c=this.operators.length;c>b;b++)if(this.operators[b].type==a)return this.operators[b];$.error("Undefined operator: "+a)},QueryBuilder.prototype.getGroupCondition=function(a){return a.find(">.rules-group-header [name$=_cond]:checked").val()},QueryBuilder.prototype.getRuleFilter=function(a){return a.find(".rule-filter-container [name$=_filter]").val()},QueryBuilder.prototype.getRuleOperator=function(a){return a.find(".rule-operator-container [name$=_operator]").val()},QueryBuilder.prototype.getRuleValue=function(a,b,c){b=b||this.getFilterById(this.getRuleFilter(a)),c=c||this.getOperatorByType(this.getRuleOperator(a));for(var d,e=[],f=a.find(".rule-value-container"),g=0;g<c.accept_values;g++){var h=a[0].id+"_value_"+g;switch(b.input){case"radio":e.push(f.find("[name="+h+"]:checked").val());break;case"checkbox":d=[],f.find("[name="+h+"]:checked").each(function(){d.push($(this).val())}),e.push(d);break;case"select":b.multiple?(d=[],f.find("[name="+h+"] option:selected").each(function(){d.push($(this).val())}),e.push(d)):e.push(f.find("[name="+h+"] option:selected").val());break;default:e.push(f.find("[name="+h+"]").val())}}return 1==c.accept_values&&(e=e[0]),b.valueParser&&(e=b.valueParser.call(this,a,e,b,c)),this.change("getRuleValue",e,a,b,c)},QueryBuilder.prototype.setRuleValue=function(a,b,c,d){if(c=c||this.getFilterById(this.getRuleFilter(a)),d=d||this.getOperatorByType(this.getRuleOperator(a)),this.trigger("beforeSetRuleValue",a,b,c,d),c.valueSetter)c.valueSetter.call(this,a,b,c,d);else{var e=a.find(".rule-value-container");b=1==d.accept_values?[b]:b;for(var f=0;f<d.accept_values;f++){var g=a[0].id+"_value_"+f;switch(c.input){case"radio":e.find("[name="+g+'][value="'+b[f]+'"]').prop("checked",!0).trigger("change");break;case"checkbox":$.isArray(b[f])||(b[f]=[b[f]]),$.each(b[f],function(a,b){e.find("[name="+g+'][value="'+b+'"]').prop("checked",!0).trigger("change")});break;default:e.find("[name="+g+"]").val(b[f]).trigger("change")}}}this.trigger("afterSetRuleValue",a,b,c,d),c.onAfterSetValue&&c.onAfterSetValue.call(this,a,b,c,d)},QueryBuilder.prototype.applyRuleFlags=function(a,b){var c=this.getRuleFlags(b);a.data("queryBuilder").flags=c,c.filter_readonly&&a.find("[name$=_filter]").prop("disabled",!0),c.operator_readonly&&a.find("[name$=_operator]").prop("disabled",!0),c.value_readonly&&a.find("[name*=_value_]").prop("disabled",!0),c.no_delete&&a.find("[data-delete=rule]").remove(),this.trigger("afterApplyRuleFlags",a,b,c)},QueryBuilder.prototype.getGroupTemplate=function(a,b){var c='<dl id="'+a+'" class="rules-group-container">   <dt class="rules-group-header">     <div class="btn-group pull-right group-actions">       <button type="button" class="btn btn-xs btn-success" data-add="rule">         <i class="'+this.icons.add_rule+'"></i> '+this.lang.add_rule+"       </button>     "+(-1===this.settings.allow_groups||this.settings.allow_groups>=b?'<button type="button" class="btn btn-xs btn-success" data-add="group">         <i class="'+this.icons.add_group+'"></i> '+this.lang.add_group+"       </button>":"")+"     "+(b>1?'<button type="button" class="btn btn-xs btn-danger" data-delete="group">         <i class="'+this.icons.remove_group+'"></i> '+this.lang.delete_group+"       </button>":"")+'     </div>     <div class="btn-group group-conditions">       '+this.getGroupConditions(a)+"     </div>   "+(this.settings.display_errors?'<div class="error-container" data-toggle="tooltip" data-placement="right"><i class="'+this.icons.error+'"></i></div>':"")+"  </dt>   <dd class=rules-group-body>     <ul class=rules-list></ul>   </dd> </dl>";return this.change("getGroupTemplate",c,b)},QueryBuilder.prototype.getGroupConditions=function(a){for(var b="",c=0,d=this.settings.conditions.length;d>c;c++){var e=this.settings.conditions[c],f=e==this.settings.default_condition,g=this.lang["condition_"+e.toLowerCase()]||e;b+='            <label class="btn btn-xs btn-primary '+(f?"active":"")+'">               <input type="radio" name="'+a+'_cond" value="'+e+'" '+(f?"checked":"")+"> "+g+"             </label>"}return this.change("getGroupConditions",b)},QueryBuilder.prototype.getRuleTemplate=function(a){var b='<li id="'+a+'" class="rule-container">   <div class="rule-header">     <div class="btn-group pull-right rule-actions">       <button type="button" class="btn btn-xs btn-danger" data-delete="rule">         <i class="'+this.icons.remove_rule+'"></i> '+this.lang.delete_rule+"       </button>     </div>   </div>   "+(this.settings.display_errors?'<div class="error-container"><i class="'+this.icons.error+'"></i></div>':"")+'  <div class="rule-filter-container"></div>   <div class="rule-operator-container"></div>   <div class="rule-value-container"></div> </li>';return this.change("getRuleTemplate",b)},QueryBuilder.prototype.getRuleFilterSelect=function(a){var b=null,c='<select name="'+a+'_filter">';return c+='<option value="-1">'+this.lang.filter_select_placeholder+"</option>",$.each(this.filters,function(a,d){b!=d.optgroup&&(null!==b&&(c+="</optgroup>"),b=d.optgroup,null!==b&&(c+='<optgroup label="'+b+'">')),c+='<option value="'+d.id+'">'+d.label+"</option>"}),null!==b&&(c+="</optgroup>"),c+="</select>",this.change("getRuleFilterSelect",c)},QueryBuilder.prototype.getRuleOperatorSelect=function(a,b){for(var c='<select name="'+a+'_operator">',d=0,e=b.length;e>d;d++){var f=this.lang.operators[b[d].type]||b[d].type;c+='<option value="'+b[d].type+'">'+f+"</option>"}return c+="</select>",this.change("getRuleOperatorSelect",c)},QueryBuilder.prototype.getRuleInput=function(a,b,c){var d,e=b.validation||{},f=a[0].id+"_value_"+c,g="";if("function"==typeof b.input)g=b.input.call(this,a,b,f);else switch(b.input){case"radio":d=b.vertical?" class=block":"",iterateOptions(b.values,function(a,b){g+="<label"+d+'><input type="radio" name="'+f+'" value="'+a+'"> '+b+"</label> "});break;case"checkbox":d=b.vertical?" class=block":"",iterateOptions(b.values,function(a,b){g+="<label"+d+'><input type="checkbox" name="'+f+'" value="'+a+'"> '+b+"</label> "});break;case"select":g+='<select name="'+f+'"'+(b.multiple?" multiple":"")+">",iterateOptions(b.values,function(a,b){g+='<option value="'+a+'"> '+b+"</option> "}),g+="</select>";break;case"textarea":g+='<textarea name="'+f+'"',b.size&&(g+=' cols="'+b.size+'"'),b.rows&&(g+=' rows="'+b.rows+'"'),void 0!==e.min&&(g+=' minlength="'+e.min+'"'),void 0!==e.max&&(g+=' maxlength="'+e.max+'"'),b.placeholder&&(g+=' placeholder="'+b.placeholder+'"'),g+="></textarea>";break;default:switch(b.internalType){case"number":g+='<input type="number" name="'+f+'"',void 0!==e.step&&(g+=' step="'+e.step+'"'),void 0!==e.min&&(g+=' min="'+e.min+'"'),void 0!==e.max&&(g+=' max="'+e.max+'"'),b.placeholder&&(g+=' placeholder="'+b.placeholder+'"'),b.size&&(g+=' size="'+b.size+'"'),g+=">";break;default:g+='<input type="text" name="'+f+'"',b.placeholder&&(g+=' placeholder="'+b.placeholder+'"'),"string"===b.type&&void 0!==e.min&&(g+=' minlength="'+e.min+'"'),"string"===b.type&&void 0!==e.max&&(g+=' maxlength="'+e.max+'"'),b.size&&(g+=' size="'+b.size+'"'),g+=">"}}return this.change("getRuleInput",g,a,b,f)},QueryBuilder.prototype.getRuleFlags=function(a){var b=$.extend({},this.settings.default_rule_flags);return a.readonly&&$.extend(b,{filter_readonly:!0,operator_readonly:!0,value_readonly:!0,no_delete:!0}),a.flags&&$.extend(b,a.flags),this.change("getRuleFlags",b,a)},$.fn.queryBuilder=function(a){this.length>1&&$.error("Unable to initialize on multiple target");var b=this.data("queryBuilder"),c="object"==typeof a&&a||{};return b||"destroy"!=a?(b||this.data("queryBuilder",new QueryBuilder(this,c)),"string"==typeof a?b[a].apply(b,Array.prototype.slice.call(arguments,1)):this):this},$.fn.queryBuilder.defaults={set:function(a){$.extendext(!0,"replace",QueryBuilder.DEFAULTS,a)},get:function(a){var b=QueryBuilder.DEFAULTS;return a&&(b=b[a]),$.extend(!0,{},b)}},$.fn.queryBuilder.constructor=QueryBuilder,$.fn.queryBuilder.extend=QueryBuilder.extend,$.fn.queryBuilder.define=QueryBuilder.define,$.fn.queryBuilder.define("bt-selectpicker",function(a){$.fn.selectpicker&&$.fn.selectpicker.Constructor||$.error('Bootstrap Select is required to use "bt-selectpicker" plugin. Get it here: http://silviomoreto.github.io/bootstrap-select'),a=$.extend({container:"body",style:"btn-inverse btn-xs",width:"auto",showIcon:!1},a||{}),this.on("afterAddRule",function(b){b.find(".rule-filter-container select").selectpicker(a)}),this.on("afterCreateRuleOperators",function(b){b.find(".rule-operator-container select").selectpicker(a)})}),$.fn.queryBuilder.define("bt-tooltip-errors",function(a){$.fn.tooltip&&$.fn.tooltip.Constructor&&$.fn.tooltip.Constructor.prototype.fixTitle||$.error('Bootstrap Tooltip is required to use "bt-tooltip-errors" plugin. Get it here: http://getbootstrap.com'),a=$.extend({placement:"right"},a||{}),this.on("getRuleTemplate",function(a){return a.replace('class="error-container"','class="error-container" data-toggle="tooltip"')}),this.on("validationError",function(b){b.find(".error-container").eq(0).tooltip(a).tooltip("hide").tooltip("fixTitle")})}),$.fn.queryBuilder.define("filter-description",function(a){a=$.extend({icon:"glyphicon glyphicon-info-sign",mode:"popover"},a||{}),"inline"===a.mode?this.on("afterUpdateRuleFilter",function(b,c){var d=b.find("p.filter-description");c&&c.description?(0===d.length?(d=$('<p class="filter-description"></p>'),d.appendTo(b)):d.show(),d.html('<i class="'+a.icon+'"></i> '+c.description)):d.hide()}):"popover"===a.mode?($.fn.popover&&$.fn.popover.Constructor&&$.fn.popover.Constructor.prototype.fixTitle||$.error('Bootstrap Popover is required to use "filter-description" plugin. Get it here: http://getbootstrap.com'),this.on("afterUpdateRuleFilter",function(b,c){var d=b.find("button.filter-description");c&&c.description?(0===d.length?(d=$('<button type="button" class="btn btn-xs btn-info filter-description" data-toggle="popover"><i class="'+a.icon+'"></i></button>'),d.prependTo(b.find(".rule-actions")),d.popover({placement:"left",container:"body",html:!0}),d.on("mouseout",function(){d.popover("hide")})):d.show(),d.data("bs.popover").options.content=c.description,d.attr("aria-describedby")&&d.popover("show")):(d.hide(),d.data("bs.popover")&&d.popover("hide"))})):"bootbox"===a.mode&&(window.bootbox||$.error('Bootbox is required to use "filter-description" plugin. Get it here: http://bootboxjs.com'),this.on("afterUpdateRuleFilter",function(b,c){var d=b.find("button.filter-description");c&&c.description?(0===d.length&&(d=$('<button type="button" class="btn btn-xs btn-info filter-description"><i class="'+a.icon+'"></i></button>'),d.prependTo(b.find(".rule-actions")),d.on("click",function(){bootbox.alert(d.data("description"))})),d.data("description",c.description)):d.hide()}))}),$.fn.queryBuilder.defaults.set({mongoOperators:{equal:function(a){return a[0]},not_equal:function(a){return{$ne:a[0]}},"in":function(a){return{$in:a}},not_in:function(a){return{$nin:a}},less:function(a){return{$lt:a[0]}},less_or_equal:function(a){return{$lte:a[0]}},greater:function(a){return{$gt:a[0]}},greater_or_equal:function(a){return{$gte:a[0]}},between:function(a){return{$gte:a[0],$lte:a[1]}},begins_with:function(a){return{$regex:"^"+escapeRegExp(a[0])}},not_begins_with:function(a){return{$regex:"^(?!"+escapeRegExp(a[0])+")"}},contains:function(a){return{$regex:escapeRegExp(a[0])}},not_contains:function(a){return{$regex:"^((?!"+escapeRegExp(a[0])+").)*$",$options:"s"}},ends_with:function(a){return{$regex:escapeRegExp(a[0])+"$"}},not_ends_with:function(a){return{$regex:"(?<!"+escapeRegExp(a[0])+")$"}},is_empty:function(){return""},is_not_empty:function(){return{$ne:""}},is_null:function(){return null},is_not_null:function(){return{$ne:null}}}}),$.fn.queryBuilder.extend({getMongo:function(a){a=void 0===a?this.getRules():a;var b=this;return function c(a){if(a.condition||(a.condition=b.settings.default_condition),-1===["AND","OR"].indexOf(a.condition.toUpperCase())&&$.error("Unable to build MongoDB query with "+a.condition+" condition"),!a.rules)return{};var d=[];$.each(a.rules,function(a,e){if(e.rules&&e.rules.length>0)d.push(c(e));else{var f=b.settings.mongoOperators[e.operator],g=b.getOperatorByType(e.operator),h=[];void 0===f&&$.error("MongoDB operation unknown for operator "+e.operator),g.accept_values&&(e.value instanceof Array||(e.value=[e.value]),e.value.forEach(function(a){h.push(changeType(a,e.type,"mongo"))}));var i={};i[e.field]=f.call(b,h),d.push(i)}});var e={};return d.length>0&&(e["$"+a.condition.toLowerCase()]=d),e}(a)}}),$.fn.queryBuilder.define("sortable",function(a){a=$.extend({default_no_sortable:!1,icon:"glyphicon glyphicon-sort"},a||{}),this.on("afterInit",function(){$.event.props.push("dataTransfer");var a,b,c=this;this.$el.on("mouseover",".drag-handle",function(){c.$el.find(".rule-container, .rules-group-container").attr("draggable",!0)}),this.$el.on("mouseout",".drag-handle",function(){c.$el.find(".rule-container, .rules-group-container").removeAttr("draggable")}),this.$el.on("dragstart","[draggable]",function(c){c.stopPropagation(),c.dataTransfer.setData("text","drag"),b=$(c.target),a=$('<div class="rule-placeholder">&nbsp;</div>'),a.css("min-height",b.height()),a.insertAfter(b),setTimeout(function(){b.hide()},0)}),this.$el.on("dragenter","[draggable]",function(b){b.preventDefault(),b.stopPropagation(),moveSortableToTarget(a,$(b.target))}),this.$el.on("dragover","[draggable]",function(a){a.preventDefault(),a.stopPropagation()}),this.$el.on("drop",function(a){a.preventDefault(),a.stopPropagation(),moveSortableToTarget(b,$(a.target))
}),this.$el.on("dragend","[draggable]",function(d){d.preventDefault(),d.stopPropagation(),b.show(),a.remove(),b=a=null,c.$el.find(".rule-container, .rules-group-container").removeAttr("draggable")})}),this.on("getRuleFlags",function(b){return void 0===b.no_sortable&&(b.no_sortable=a.default_no_sortable),b}),this.on("afterApplyRuleFlags",function(a,b,c){c.no_sortable&&a.find(".drag-handle").remove()}),this.on("getGroupTemplate",function(b,c){if(c>1){var d=$(b);d.find(".group-conditions").after('<div class="drag-handle"><i class="'+a.icon+'"></i></div>'),b=d.prop("outerHTML")}return b}),this.on("getRuleTemplate",function(b){var c=$(b);return c.find(".rule-header").after('<div class="drag-handle"><i class="'+a.icon+'"></i></div>'),c.prop("outerHTML")})}),$.fn.queryBuilder.defaults.set({sqlOperators:{equal:"= ?",not_equal:"!= ?","in":{op:"IN(?)",list:!0,sep:", "},not_in:{op:"NOT IN(?)",list:!0,sep:", "},less:"< ?",less_or_equal:"<= ?",greater:"> ?",greater_or_equal:">= ?",between:{op:"BETWEEN ?",list:!0,sep:" AND "},begins_with:{op:"LIKE(?)",fn:function(a){return a+"%"}},not_begins_with:{op:"NOT LIKE(?)",fn:function(a){return a+"%"}},contains:{op:"LIKE(?)",fn:function(a){return"%"+a+"%"}},not_contains:{op:"NOT LIKE(?)",fn:function(a){return"%"+a+"%"}},ends_with:{op:"LIKE(?)",fn:function(a){return"%"+a}},not_ends_with:{op:"NOT LIKE(?)",fn:function(a){return"%"+a}},is_empty:'== ""',is_not_empty:'!= ""',is_null:"IS NULL",is_not_null:"IS NOT NULL"}}),$.fn.queryBuilder.extend({getSQL:function(a,b,c){c=void 0===c?this.getRules():c,a=a===!0||void 0===a?"question_mark":a,b=b||void 0===b?"\n":" ";var d=this,e=1,f=[],g=function h(c){if(c.condition||(c.condition=d.settings.default_condition),-1===["AND","OR"].indexOf(c.condition.toUpperCase())&&$.error("Unable to build SQL query with "+c.condition+" condition"),!c.rules)return"";var g=[];return $.each(c.rules,function(c,i){if(i.rules&&i.rules.length>0)g.push("("+b+h(i)+b+")"+b);else{var j=d.getSqlOperator(i.operator),k=d.getOperatorByType(i.operator),l="";j===!1&&$.error("SQL operation unknown for operator "+i.operator),k.accept_values&&(i.value instanceof Array?!j.list&&i.value.length>1&&$.error("Operator "+i.operator+" cannot accept multiple values"):i.value=[i.value],i.value.forEach(function(b,c){c>0&&(l+=j.sep),"integer"==i.type||"double"==i.type||"boolean"==i.type?b=changeType(b,i.type,"sql"):a||(b=escapeString(b)),j.fn&&(b=j.fn(b)),a?(l+="question_mark"==a?"?":"$"+e,f.push(b),e++):("string"==typeof b&&(b="'"+b+"'"),l+=b)})),g.push(i.field+" "+j.op.replace(/\?/,l))}}),g.join(" "+c.condition+b)}(c);return a?{sql:g,params:f}:{sql:g}},getSqlOperator:function(a){var b=this.settings.sqlOperators[a];return void 0===b?!1:("string"==typeof b&&(b={op:b}),b.list||(b.list=!1),b.list&&!b.sep&&(b.sep=", "),b)}});